<!DOCTYPE html>
<html>
<head>
    <title>Generate Faculty Avatars</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }
        canvas {
            border: 1px solid #ccc;
            margin: 10px;
        }
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .avatar-item {
            text-align: center;
        }
        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <h1>Generate Faculty Avatars</h1>
    <p>This will generate pixel art avatars for faculty members and store them in the database.</p>
    <button onclick="generateAll()">Generate All Avatars</button>
    <div id="status"></div>
    <div id="avatars" class="avatar-grid"></div>

    <script type="module">
        const SUPABASE_URL = 'https://xougqdomkoisrxdnagcj.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_1Zt0VjMX57VdYC7dH-GG1A_RFZyuwc9';

        // Generate avatar from name
        function generateAvatar(name, size = 32) {
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            
            // Generate color from name hash
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const hue = Math.abs(hash % 360);
            const saturation = 60 + (Math.abs(hash) % 20);
            const lightness = 45 + (Math.abs(hash) % 15);
            const color = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            
            // Draw background circle
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(size / 2, size / 2, size / 2 - 2, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw border
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Draw simple face
            ctx.fillStyle = '#ffffff';
            // Eyes
            const eyeY = size * 0.4;
            const eyeSize = size * 0.12;
            ctx.beginPath();
            ctx.arc(size * 0.35, eyeY, eyeSize, 0, Math.PI * 2);
            ctx.arc(size * 0.65, eyeY, eyeSize, 0, Math.PI * 2);
            ctx.fill();
            
            // Mouth (simple smile)
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(size / 2, size * 0.65, size * 0.15, 0, Math.PI);
            ctx.stroke();
            
            return canvas.toDataURL('image/png');
        }

        async function generateAll() {
            const statusDiv = document.getElementById('status');
            const avatarsDiv = document.getElementById('avatars');
            avatarsDiv.innerHTML = '';
            statusDiv.textContent = 'Loading faculty...';

            try {
                // Fetch faculty
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/faculty?select=id,name,surname,slug,avatar_url&limit=100`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const faculty = await response.json();
                statusDiv.textContent = `Found ${faculty.length} faculty members. Generating avatars...`;

                let generated = 0;
                let skipped = 0;

                for (const member of faculty) {
                    const displayName = member.surname 
                        ? `${member.name} ${member.surname}` 
                        : member.name;
                    
                    // Skip if already has avatar
                    if (member.avatar_url) {
                        skipped++;
                        continue;
                    }

                    const avatarDataUrl = generateAvatar(displayName);

                    // Display avatar
                    const item = document.createElement('div');
                    item.className = 'avatar-item';
                    const img = document.createElement('img');
                    img.src = avatarDataUrl;
                    img.style.width = '64px';
                    img.style.height = '64px';
                    img.style.borderRadius = '50%';
                    item.appendChild(img);
                    item.appendChild(document.createTextNode(displayName));
                    avatarsDiv.appendChild(item);

                    // Update in database (would need service role key for this)
                    // For now, just display
                    generated++;
                }

                statusDiv.textContent = `Generated ${generated} avatars, ${skipped} already had avatars.`;
                statusDiv.innerHTML += '<br><small>Note: To save to database, run the migration and use the Node.js script with service role key.</small>';

            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
                console.error(error);
            }
        }

        window.generateAll = generateAll;
    </script>
</body>
</html>
